server {
    listen ${PORT}; # ¡IMPORTANTE! Nginx escuchará en el puerto asignado por Render
    server_name localhost; # Nombre del servidor, puedes dejar localhost

    # La raíz del documento apunta al directorio 'public' de tu Laravel dentro del contenedor.
    # Recuerda que tu código Laravel está en /var/www/html dentro del contenedor.
    root /var/www/html/public;

    # Encabezados de seguridad comunes para aplicaciones web.
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";

    # Archivos de índice por defecto que Nginx buscará.
    index index.html index.htm index.php;

    # Codificación de caracteres.
    charset utf-8;

    # Regla principal para Laravel: si un archivo o directorio solicitado no existe,
    # Nginx redirige la solicitud a index.php (el punto de entrada de Laravel).
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Bloquea el acceso directo a favicon.ico y robots.txt para evitar logs innecesarios.
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # Página de error 404 personalizada de Laravel.
    error_page 404 /index.php;

    # Configuración para procesar archivos PHP con PHP-FPM.
    location ~ \.php$ {
        # Conecta con el socket de PHP-FPM (FastCGI Process Manager)
        # que es parte de la imagen Docker que estamos usando.
        fastcgi_pass unix:/var/run/php-fpm.sock;
        fastcgi_index index.php;
        # Define la ruta completa del script PHP que PHP-FPM debe ejecutar.
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        # Incluye parámetros FastCGI estándar.
        include fastcgi_params;
    }

    # Deniega el acceso a archivos ocultos (archivos que empiezan con un punto, como .env).
    # Se excluye .well-known porque es usado por Let's Encrypt para certificados SSL.
    location ~ /\.(?!well-known).* {
        deny all;
    }
}